# 5.5. Methods

**configure(config)**
: [Enqueues a control message](#enqueues-a-control-message) to configure the audio encoder for encoding audio data as described by config.

NOTE: This method will trigger a [`NotSupportedError`](https://webidl.spec.whatwg.org/#notsupportederror) if the User Agent does not support config. Authors are encouraged to first check support by calling [`isConfigSupported()`](#dom-audioencoder-isconfigsupported) with config. User Agents don’t have to support any particular codec type or configuration.

When invoked, run these steps:

1.  If config is not a [valid AudioEncoderConfig](#valid-audioencoderconfig), throw a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
2.  If [`[[state]]`](#dom-audioencoder-state-slot) is `"closed"`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror).
3.  Set [`[[state]]`](#dom-audioencoder-state-slot) to `"configured"`.
4.  [Queue a control message](#enqueues-a-control-message) to configure the encoder using config.
5.  [Process the control message queue](#process-the-control-message-queue).

[Running a control message](#running-a-control-message) to configure the encoder means performing these steps:

1.  Assign `true` to [`[[message queue blocked]]`](#dom-audioencoder-message-queue-blocked-slot).
2.  Enqueue the following steps to [`[[codec work queue]]`](#dom-audioencoder-codec-work-queue-slot):
    1.  Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
    2.  If supported is `false`, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close AudioEncoder](#close-audioencoder) algorithm with [`NotSupportedError`](https://webidl.spec.whatwg.org/#notsupportederror) and abort these steps.
    3.  If needed, assign [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) with an implementation supporting config.
    4.  Configure [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) with config.
    5.  [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
        1.  Assign `false` to [`[[message queue blocked]]`](#dom-audioencoder-message-queue-blocked-slot).
        2.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to [Process the control message queue](#process-the-control-message-queue).

3.  Return `"processed"`.

**encode(data)**
: [Enqueues a control message](#enqueues-a-control-message) to encode the given data.

When invoked, run these steps:

1.  If the value of data’s [`[[Detached]]`](https://html.spec.whatwg.org/multipage/structured-data.html#detached) internal slot is `true`, throw a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
2.  If [`[[state]]`](#dom-audioencoder-state-slot) is not `"configured"`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror).
3.  Let dataClone hold the result of running the [Clone AudioData](#clone-audiodata) algorithm with data.
4.  Increment [`[[encodeQueueSize]]`](#dom-audioencoder-encodequeuesize-slot).
5.  [Queue a control message](#enqueues-a-control-message) to encode dataClone.
6.  [Process the control message queue](#process-the-control-message-queue).

[Running a control message](#running-a-control-message) to encode the data means performing these steps:

1.  If [`[[codec saturated]]`](#dom-audioencoder-codec-saturated-slot) equals `true`, return `"not processed"`.
2.  If encoding data will cause the [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) to become [saturated](#saturated), assign `true` to [`[[codec saturated]]`](#dom-audioencoder-codec-saturated-slot).
3.  Decrement [`[[encodeQueueSize]]`](#dom-audioencoder-encodequeuesize-slot) and run the [Schedule Dequeue Event](#audioencoder-schedule-dequeue-event) algorithm.
4.  Enqueue the following steps to the [`[[codec work queue]]`](#dom-audioencoder-codec-work-queue-slot):
    1.  Attempt to use [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) to encode the [media resource](#media-resource) described by dataClone.
    2.  If encoding results in an error, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close AudioEncoder](#close-audioencoder) algorithm with [`EncodingError`](https://webidl.spec.whatwg.org/#encodingerror) and return.
    3.  If [`[[codec saturated]]`](#dom-audioencoder-codec-saturated-slot) equals `true` and [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) is no longer [saturated](#saturated), [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform the following steps:
        1.  Assign `false` to [`[[codec saturated]]`](#dom-audioencoder-codec-saturated-slot).
        2.  [Process the control message queue](#process-the-control-message-queue).

    4.  Let encoded outputs be a [list](https://infra.spec.whatwg.org/#list) of encoded audio data outputs emitted by [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot).
    5.  If encoded outputs is not empty, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Output EncodedAudioChunks](#output-encodedaudiochunks) algorithm with encoded outputs.

5.  Return `"processed"`.

**flush()**
: Completes all [control messages](#control-message) in the [control message queue](#control-message-queue) and emits all outputs.

When invoked, run these steps:

1.  If [`[[state]]`](#dom-audioencoder-state-slot) is not `"configured"`, return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
2.  Let promise be a new Promise.
3.  Append promise to [`[[pending flush promises]]`](#dom-audioencoder-pending-flush-promises-slot).
4.  [Queue a control message](#enqueues-a-control-message) to flush the codec with promise.
5.  [Process the control message queue](#process-the-control-message-queue).
6.  Return promise.

[Running a control message](#running-a-control-message) to flush the codec means performing these steps with promise.

1.  Enqueue the following steps to the [`[[codec work queue]]`](#dom-audioencoder-codec-work-queue-slot):
    1.  Signal [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) to emit all [internal pending outputs](#internal-pending-output).
    2.  Let encoded outputs be a [list](https://infra.spec.whatwg.org/#list) of encoded audio data outputs emitted by [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot).
    3.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform these steps:
        1.  If encoded outputs is not empty, run the [Output EncodedAudioChunks](#output-encodedaudiochunks) algorithm with encoded outputs.
        2.  Remove promise from [`[[pending flush promises]]`](#dom-audioencoder-pending-flush-promises-slot).
        3.  Resolve promise.

2.  Return `"processed"`.

**reset()**
: Immediately resets all state including configuration, [control messages](#control-message) in the [control message queue](#control-message-queue), and all pending callbacks.

When invoked, run the [Reset AudioEncoder](#reset-audioencoder) algorithm with an [`AbortError`](https://webidl.spec.whatwg.org/#aborterror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).

**close()**
: Immediately aborts all pending work and releases [system resources](#system-resources). Close is final.

When invoked, run the [Close AudioEncoder](#close-audioencoder) algorithm with an [`AbortError`](https://webidl.spec.whatwg.org/#aborterror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).

**isConfigSupported(config)**
: Returns a promise indicating whether the provided config is supported by the User Agent.

NOTE: The returned [`AudioEncoderSupport`](#dictdef-audioencodersupport) [`config`](#dom-audioencodersupport-config) will contain only the dictionary members that User Agent recognized. Unrecognized dictionary members will be ignored. Authors can detect unrecognized dictionary members by comparing [`config`](#dom-audioencodersupport-config) to their provided config.

When invoked, run these steps:

1.  If config is not a [valid AudioEncoderConfig](#valid-audioencoderconfig), return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
2.  Let p be a new Promise.
3.  Let checkSupportQueue be the result of starting a new [parallel queue](https://html.spec.whatwg.org/multipage/infrastructure.html#parallel-queue).
4.  Enqueue the following steps to checkSupportQueue:
    1.  Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
    2.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
        1.  Let encoderSupport be a newly constructed [`AudioEncoderSupport`](#dictdef-audioencodersupport), initialized as follows:
            1.  Set [`config`](#dom-audioencodersupport-config) to the result of running the [Clone Configuration](#clone-configuration) algorithm with config.
            2.  Set [`supported`](#dom-audioencodersupport-supported) to supported.

        2.  Resolve p with encoderSupport.

5.  Return p.

---

[← Back to 5. AudioEncoder Interface](../5-audioencoder-interface/TOC.md)
