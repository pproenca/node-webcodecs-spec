# 5.6. Algorithms

**Schedule Dequeue Event**
: 1. If [`[[dequeue event scheduled]]`](#dom-audioencoder-dequeue-event-scheduled-slot) equals `true`, return.

2.  Assign `true` to [`[[dequeue event scheduled]]`](#dom-audioencoder-dequeue-event-scheduled-slot).
3.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
    1.  Fire a simple event named [`dequeue`](#eventdef-audioencoder-dequeue) at [this](https://webidl.spec.whatwg.org/#this).
    2.  Assign `false` to [`[[dequeue event scheduled]]`](#dom-audioencoder-dequeue-event-scheduled-slot).

**Output EncodedAudioChunks (with outputs)**
: Run these steps:

1.  For each output in outputs:
    1.  Let chunkInit be an [`EncodedAudioChunkInit`](#dictdef-encodedaudiochunkinit) with the following keys:
        1.  Let [`data`](#dom-encodedaudiochunkinit-data) contain the encoded audio data from output.
        2.  Let [`type`](#dom-encodedaudiochunkinit-type) be the [`EncodedAudioChunkType`](#enumdef-encodedaudiochunktype) of output.
        3.  Let [`timestamp`](#dom-encodedaudiochunkinit-timestamp) be the [`timestamp`](#dom-audiodata-timestamp) from the AudioData associated with output.
        4.  Let [`duration`](#dom-encodedaudiochunkinit-duration) be the [`duration`](#dom-audiodata-duration) from the AudioData associated with output.

    2.  Let chunk be a new [`EncodedAudioChunk`](#encodedaudiochunk) constructed with chunkInit.
    3.  Let chunkMetadata be a new [`EncodedAudioChunkMetadata`](#dictdef-encodedaudiochunkmetadata).
    4.  Let encoderConfig be the [`[[active encoder config]]`](#dom-audioencoder-active-encoder-config-slot).
    5.  Let outputConfig be a new [`AudioDecoderConfig`](#dictdef-audiodecoderconfig) that describes output. Initialize outputConfig as follows:
        1.  Assign encoderConfig.[`codec`](#dom-audioencoderconfig-codec) to outputConfig.[`codec`](#dom-audiodecoderconfig-codec).
        2.  Assign encoderConfig.[`sampleRate`](#dom-audioencoderconfig-samplerate) to outputConfig.[`sampleRate`](#dom-audiodecoderconfig-samplerate).
        3.  Assign to encoderConfig.[`numberOfChannels`](#dom-audioencoderconfig-numberofchannels) to outputConfig.[`numberOfChannels`](#dom-audiodecoderconfig-numberofchannels).
        4.  Assign outputConfig.[`description`](#dom-audiodecoderconfig-description) with a sequence of codec specific bytes as determined by the [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot). The User Agent _MUST_ ensure that the provided description could be used to correctly decode output.

            NOTE: The codec specific requirements for populating the [`description`](#dom-audiodecoderconfig-description) are described in the [\[WEBCODECS-CODEC-REGISTRY\]](#biblio-webcodecs-codec-registry 'WebCodecs Codec Registry').

    6.  If outputConfig and [`[[active output config]]`](#dom-audioencoder-active-output-config-slot) are not [equal dictionaries](#equal-dictionaries):
        1.  Assign outputConfig to chunkMetadata.[`decoderConfig`](#dom-encodedaudiochunkmetadata-decoderconfig).
        2.  Assign outputConfig to [`[[active output config]]`](#dom-audioencoder-active-output-config-slot).

    7.  Invoke [`[[output callback]]`](#dom-audioencoder-output-callback-slot) with chunk and chunkMetadata.

**Reset AudioEncoder (with exception)**
: Run these steps:

1.  If [`[[state]]`](#dom-audioencoder-state-slot) is `"closed"`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror).
2.  Set [`[[state]]`](#dom-audioencoder-state-slot) to `"unconfigured"`.
3.  Set [`[[active encoder config]]`](#dom-audioencoder-active-encoder-config-slot) to `null`.
4.  Set [`[[active output config]]`](#dom-audioencoder-active-output-config-slot) to `null`.
5.  Signal [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) to cease producing output for the previous configuration.
6.  Remove all [control messages](#control-message) from the [`[[control message queue]]`](#dom-audioencoder-control-message-queue-slot).
7.  If [`[[encodeQueueSize]]`](#dom-audioencoder-encodequeuesize-slot) is greater than zero:
    1.  Set [`[[encodeQueueSize]]`](#dom-audioencoder-encodequeuesize-slot) to zero.
    2.  Run the [Schedule Dequeue Event](#audioencoder-schedule-dequeue-event) algorithm.

8.  For each promise in [`[[pending flush promises]]`](#dom-audioencoder-pending-flush-promises-slot):
    1.  Reject promise with exception.
    2.  Remove promise from [`[[pending flush promises]]`](#dom-audioencoder-pending-flush-promises-slot).

**Close AudioEncoder (with exception)**
: Run these steps:

1.  Run the [Reset AudioEncoder](#reset-audioencoder) algorithm with exception.
2.  Set [`[[state]]`](#dom-audioencoder-state-slot) to `"closed"`.
3.  Clear [`[[codec implementation]]`](#dom-audioencoder-codec-implementation-slot) and release associated [system resources](#system-resources).
4.  If exception is not an [`AbortError`](https://webidl.spec.whatwg.org/#aborterror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException), invoke the [`[[error callback]]`](#dom-audioencoder-error-callback-slot) with exception.

---

[‚Üê Back to 5. AudioEncoder Interface](../5-audioencoder-interface/TOC.md)
