# 10.2.5. Algorithms

**Fetch Stream Data Loop (with reader)**
: Run these steps:

1.  Let readRequest be the following [read request](https://streams.spec.whatwg.org/#read-request).

    **chunk steps, given chunk**
    : 1. If [`[[closed]]`](#dom-imagedecoder-closed-slot) is `true`, abort these steps. 2. If chunk is not a Uint8Array object, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close ImageDecoder](#imagedecoder-close-imagedecoder) algorithm with a [`DataError`](https://webidl.spec.whatwg.org/#dataerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException) and abort these steps. 3. Let bytes be the byte sequence represented by the Uint8Array object. 4. Append bytes to the [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) internal slot. 5. If [`[[tracks established]]`](#dom-imagedecoder-tracks-established-slot) is `false`, run the [Establish Tracks](#imagedecoder-establish-tracks) algorithm. 6. Otherwise, run the [Update Tracks](#imagedecoder-update-tracks) algorithm. 7. Run the [Fetch Stream Data Loop](#imagedecoder-fetch-stream-data-loop) algorithm with reader.

    **close steps**
    : 1. Assign `true` to [`[[complete]]`](#dom-imagedecoder-complete-slot) 2. Resolve [`[[completed promise]]`](#dom-imagedecoder-completed-promise-slot).

    **error steps**
    : 1. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close ImageDecoder](#imagedecoder-close-imagedecoder) algorithm with a [`NotReadableError`](https://webidl.spec.whatwg.org/#notreadableerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException)

2.  Read a chunk from reader given readRequest.

**Establish Tracks**
: Run these steps:

1.  Assert [`[[tracks established]]`](#dom-imagedecoder-tracks-established-slot) is `false`.
2.  If [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) does not contain enough data to determine the number of tracks:
    1.  If [`complete`](#dom-imagedecoder-complete) is `true`, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close ImageDecoder](#imagedecoder-close-imagedecoder) algorithm with a [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
    2.  Abort these steps.

3.  If the number of tracks is found to be `0`, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close ImageDecoder](#imagedecoder-close-imagedecoder) algorithm and abort these steps.
4.  Let newTrackList be a new [list](https://infra.spec.whatwg.org/#list).
5.  For each image track found in [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot):
    1.  Let newTrack be a new [`ImageTrack`](#imagetrack), initialized as follows:
        1.  Assign [this](https://webidl.spec.whatwg.org/#this) to [`[[ImageDecoder]]`](#dom-imagetrack-imagedecoder-slot).
        2.  Assign [`tracks`](#dom-imagedecoder-tracks) to [`[[ImageTrackList]]`](#dom-imagetrack-imagetracklist-slot).
        3.  If image track is found to be animated, assign `true` to newTrack’s [`[[animated]]`](#dom-imagetrack-animated-slot) internal slot. Otherwise, assign `false`.
        4.  If image track is found to describe a frame count, assign that count to newTrack’s [`[[frame count]]`](#dom-imagetrack-frame-count-slot) internal slot. Otherwise, assign `0`.

            NOTE: If [this](https://webidl.spec.whatwg.org/#this) was constructed with [`data`](#dom-imagedecoderinit-data) as a [`ReadableStream`](https://streams.spec.whatwg.org/#readablestream), the [`frameCount`](#dom-imagetrack-framecount) can change as additional bytes are appended to [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot). See the [Update Tracks](#imagedecoder-update-tracks) algorithm.

        5.  If image track is found to describe a repetition count, assign that count to [`[[repetition count]]`](#dom-imagetrack-repetition-count-slot) internal slot. Otherwise, assign `0`.

            NOTE: A value of `Infinity` indicates infinite repetitions.

        6.  Assign `false` to newTrack’s [`[[selected]]`](#dom-imagetrack-selected-slot) internal slot.

    2.  Append newTrack to newTrackList.

6.  Let selectedTrackIndex be the result of running the [Get Default Selected Track Index](#imagedecoder-get-default-selected-track-index) algorithm with newTrackList.
7.  Let selectedTrack be the track at position selectedTrackIndex within newTrackList.
8.  Assign `true` to selectedTrack’s [`[[selected]]`](#dom-imagetrack-selected-slot) internal slot.
9.  Assign selectedTrackIndex to [`[[internal selected track index]]`](#dom-imagedecoder-internal-selected-track-index-slot).
10. Assign `true` to [`[[tracks established]]`](#dom-imagedecoder-tracks-established-slot).
11. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform the following steps:
    1.  Assign newTrackList to the [`tracks`](#dom-imagedecoder-tracks) [`[[track list]]`](#dom-imagetracklist-track-list-slot) internal slot.
    2.  Assign selectedTrackIndex to [`tracks`](#dom-imagedecoder-tracks) [`[[selected index]]`](#dom-imagetracklist-selected-index-slot).
    3.  Resolve [`[[ready promise]]`](#dom-imagetracklist-ready-promise-slot).

**Get Default Selected Track Index (with trackList)**
: Run these steps:

1.  If [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) identifies a [Primary Image Track](#primary-image-track):
    1.  Let primaryTrack be the [`ImageTrack`](#imagetrack) from trackList that describes the [Primary Image Track](#primary-image-track).
    2.  Let primaryTrackIndex be position of primaryTrack within trackList.
    3.  If [`[[prefer animation]]`](#dom-imagedecoder-prefer-animation-slot) is `null`, return primaryTrackIndex.
    4.  If primaryTrack.[`animated`](#dom-imagetrack-animated) equals [`[[prefer animation]]`](#dom-imagedecoder-prefer-animation-slot), return primaryTrackIndex.

2.  If any [`ImageTrack`](#imagetrack)s in trackList have [`animated`](#dom-imagetrack-animated) equal to [`[[prefer animation]]`](#dom-imagedecoder-prefer-animation-slot), return the position of the earliest such track in trackList.
3.  Return `0`.

**Update Tracks**
: A track update struct is a [struct](https://infra.spec.whatwg.org/#struct) that consists of a track index ([`unsigned long`](https://webidl.spec.whatwg.org/#idl-unsigned-long)) and a frame count ([`unsigned long`](https://webidl.spec.whatwg.org/#idl-unsigned-long)).

Run these steps:

1.  Assert [`[[tracks established]]`](#dom-imagedecoder-tracks-established-slot) is `true`.
2.  Let trackChanges be a new [list](https://infra.spec.whatwg.org/#list).
3.  Let trackList be a copy of [`tracks`](#dom-imagedecoder-tracks)' [`[[track list]]`](#dom-imagetracklist-track-list-slot).
4.  For each track in trackList:
    1.  Let trackIndex be the position of track in trackList.
    2.  Let latestFrameCount be the frame count as indicated by [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) for the track corresponding to track.
    3.  Assert that latestFrameCount is greater than or equal to `track.frameCount`.
    4.  If latestFrameCount is greater than `track.frameCount`:
        1.  Let change be a [track update struct](#track-update-struct) whose [track index](#track-update-struct-track-index) is trackIndex and [frame count](#track-update-struct-frame-count) is latestFrameCount.
        2.  Append change to tracksChanges.

5.  If tracksChanges [is empty](https://infra.spec.whatwg.org/#list-is-empty), abort these steps.
6.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform the following steps:
    1.  For each update in trackChanges:
        1.  Let updateTrack be the [`ImageTrack`](#imagetrack) at position `update.trackIndex` within [`tracks`](#dom-imagedecoder-tracks)' [`[[track list]]`](#dom-imagetracklist-track-list-slot).
        2.  Assign `update.frameCount` to updateTrack’s [`[[frame count]]`](#dom-imagetrack-frame-count-slot).

**Decode Complete Frame (with frameIndex and promise)**
: 1. Assert that [`[[tracks established]]`](#dom-imagedecoder-tracks-established-slot) is `true`.

2.  Assert that [`[[internal selected track index]]`](#dom-imagedecoder-internal-selected-track-index-slot) is not `-1`.
3.  Let encodedFrame be the encoded frame identified by frameIndex and [`[[internal selected track index]]`](#dom-imagedecoder-internal-selected-track-index-slot).
4.  Wait for any of the following conditions to be true (whichever happens first):
    1.  [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) contains enough bytes to completely decode encodedFrame.
    2.  [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) is found to be malformed.
    3.  [`complete`](#dom-imagedecoder-complete) is `true`.
    4.  [`[[closed]]`](#dom-imagedecoder-closed-slot) is `true`.

5.  If [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) is found to be malformed, run the [Fatally Reject Bad Data](#imagedecoder-fatally-reject-bad-data) algorithm and abort these steps.
6.  If [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) does not contain enough bytes to completely decode encodedFrame, run the [Reject Infeasible Decode](#imagedecoder-reject-infeasible-decode) algorithm with promise and abort these steps.
7.  Attempt to use [`[[codec implementation]]`](#dom-imagedecoder-codec-implementation-slot) to decode encodedFrame.
8.  If decoding produces an error, run the [Fatally Reject Bad Data](#imagedecoder-fatally-reject-bad-data) algorithm and abort these steps.
9.  If [`[[progressive frame generations]]`](#dom-imagedecoder-progressive-frame-generations-slot) contains an entry keyed by frameIndex, remove the entry from the map.
10. Let output be the decoded image data emitted by [`[[codec implementation]]`](#dom-imagedecoder-codec-implementation-slot) corresponding to encodedFrame.
11. Let decodeResult be a new [`ImageDecodeResult`](#dictdef-imagedecoderesult) initialized as follows:
    1.  Assign 'true' to [`complete`](#dom-imagedecoderesult-complete).
    2.  Let duration be the presentation duration for output as described by encodedFrame. If encodedFrame does not have a duration, assign `null` to duration.
    3.  Let timestamp be the presentation timestamp for output as described by encodedFrame. If encodedFrame does not have a timestamp:
        1.  If encodedFrame is a still image assign `0` to timestamp.
        2.  If encodedFrame is a constant rate animated image and duration is not `null`, assign `|frameIndex| * |duration|` to timestamp.
        3.  If a timestamp can otherwise be trivially generated from metadata without further decoding, assign that to timestamp.
        4.  Otherwise, assign `0` to timestamp.

    4.  If [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) contains orientation metadata describe it as rotation and flip, otherwise set rotation to 0 and flip to false.
    5.  Assign [`image`](#dom-imagedecoderesult-image) with the result of running the [Create a VideoFrame](#create-a-videoframe) algorithm with output, timestamp, duration, rotation, and flip.

12. Run the [Resolve Decode](#imagedecoder-resolve-decode) algorithm with promise and decodeResult.

**Decode Progressive Frame (with frameIndex and promise)**
: 1. Assert that [`[[tracks established]]`](#dom-imagedecoder-tracks-established-slot) is `true`.

2.  Assert that [`[[internal selected track index]]`](#dom-imagedecoder-internal-selected-track-index-slot) is not `-1`.
3.  Let encodedFrame be the encoded frame identified by frameIndex and [`[[internal selected track index]]`](#dom-imagedecoder-internal-selected-track-index-slot).
4.  Let lastFrameGeneration be `null`.
5.  If [`[[progressive frame generations]]`](#dom-imagedecoder-progressive-frame-generations-slot) contains a map entry with the key frameIndex, assign the value of the map entry to lastFrameGeneration.
6.  Wait for any of the following conditions to be true (whichever happens first):
    1.  [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) contains enough bytes to decode encodedFrame to produce an output whose [Progressive Image Frame Generation](#progressive-image-frame-generation) exceeds lastFrameGeneration.
    2.  [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) is found to be malformed.
    3.  [`complete`](#dom-imagedecoder-complete) is `true`.
    4.  [`[[closed]]`](#dom-imagedecoder-closed-slot) is `true`.

7.  If [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) is found to be malformed, run the [Fatally Reject Bad Data](#imagedecoder-fatally-reject-bad-data) algorithm and abort these steps.
8.  Otherwise, if [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) does not contain enough bytes to decode encodedFrame to produce an output whose [Progressive Image Frame Generation](#progressive-image-frame-generation) exceeds lastFrameGeneration, run the [Reject Infeasible Decode](#imagedecoder-reject-infeasible-decode) algorithm with promise and abort these steps.
9.  Attempt to use [`[[codec implementation]]`](#dom-imagedecoder-codec-implementation-slot) to decode encodedFrame.
10. If decoding produces an error, run the [Fatally Reject Bad Data](#imagedecoder-fatally-reject-bad-data) algorithm and abort these steps.
11. Let output be the decoded image data emitted by [`[[codec implementation]]`](#dom-imagedecoder-codec-implementation-slot) corresponding to encodedFrame.
12. Let decodeResult be a new [`ImageDecodeResult`](#dictdef-imagedecoderesult).
13. If output is the final full-detail progressive output corresponding to encodedFrame:
    1.  Assign `true` to decodeResult’s [`complete`](#dom-imagedecoderesult-complete).
    2.  If [`[[progressive frame generations]]`](#dom-imagedecoder-progressive-frame-generations-slot) contains an entry keyed by frameIndex, remove the entry from the map.

14. Otherwise:
    1.  Assign `false` to decodeResult’s [`complete`](#dom-imagedecoderesult-complete).
    2.  Let frameGeneration be the [Progressive Image Frame Generation](#progressive-image-frame-generation) for output.
    3.  Add a new entry to [`[[progressive frame generations]]`](#dom-imagedecoder-progressive-frame-generations-slot) with key frameIndex and value frameGeneration.

15. Let duration be the presentation duration for output as described by encodedFrame. If encodedFrame does not describe a duration, assign `null` to duration.
16. Let timestamp be the presentation timestamp for output as described by encodedFrame. If encodedFrame does not have a timestamp:
    1.  If encodedFrame is a still image assign `0` to timestamp.
    2.  If encodedFrame is a constant rate animated image and duration is not `null`, assign `|frameIndex| * |duration|` to timestamp.
    3.  If a timestamp can otherwise be trivially generated from metadata without further decoding, assign that to timestamp.
    4.  Otherwise, assign `0` to timestamp.

17. If [`[[encoded data]]`](#dom-imagedecoder-encoded-data-slot) contains orientation metadata describe it as rotation and flip, otherwise set rotation to 0 and flip to false.
18. Assign [`image`](#dom-imagedecoderesult-image) with the result of running the [Create a VideoFrame](#create-a-videoframe) algorithm with output, timestamp, duration, rotation, and flip.
19. Remove promise from [`[[pending decode promises]]`](#dom-imagedecoder-pending-decode-promises-slot).
20. Resolve promise with decodeResult.

**Resolve Decode (with promise and result)**
: 1. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform these steps:

    1.  If [`[[closed]]`](#dom-imagedecoder-closed-slot), abort these steps.

    2.  Assert that promise is an element of [`[[pending decode promises]]`](#dom-imagedecoder-pending-decode-promises-slot).

    3.  Remove promise from [`[[pending decode promises]]`](#dom-imagedecoder-pending-decode-promises-slot).

    4.  Resolve promise with result.

**Reject Infeasible Decode (with promise)**
: 1. Assert that [`complete`](#dom-imagedecoder-complete) is `true` or [`[[closed]]`](#dom-imagedecoder-closed-slot) is `true`.

2.  If [`complete`](#dom-imagedecoder-complete) is `true`, let exception be a [`RangeError`](https://webidl.spec.whatwg.org/#exceptiondef-rangeerror). Otherwise, let exception be an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
3.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform these steps:
    1.  If [`[[closed]]`](#dom-imagedecoder-closed-slot), abort these steps.
    2.  Assert that promise is an element of [`[[pending decode promises]]`](#dom-imagedecoder-pending-decode-promises-slot).
    3.  Remove promise from [`[[pending decode promises]]`](#dom-imagedecoder-pending-decode-promises-slot).
    4.  Reject promise with exception.

**Fatally Reject Bad Data**
: 1. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform these steps:

    1.  If [`[[closed]]`](#dom-imagedecoder-closed-slot), abort these steps.

    2.  Run the [Close ImageDecoder](#imagedecoder-close-imagedecoder) algorithm with an [`EncodingError`](https://webidl.spec.whatwg.org/#encodingerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).

**Check Type Support (with type)**
: 1. If the User Agent can provide a codec to support decoding type, return `true`.

2.  Otherwise, return `false`.

**Reset ImageDecoder (with exception)**
: 1. Signal [`[[codec implementation]]`](#dom-imagedecoder-codec-implementation-slot) to abort any active decoding operation.

2.  For each decodePromise in [`[[pending decode promises]]`](#dom-imagedecoder-pending-decode-promises-slot):
    1.  Reject decodePromise with exception.
    2.  Remove decodePromise from [`[[pending decode promises]]`](#dom-imagedecoder-pending-decode-promises-slot).

**Close ImageDecoder (with exception)**
: 1. Run the [Reset ImageDecoder](#imagedecoder-reset-imagedecoder) algorithm with exception.

2.  Assign `true` to [`[[closed]]`](#dom-imagedecoder-closed-slot).
3.  Clear [`[[codec implementation]]`](#dom-imagedecoder-codec-implementation-slot) and release associated [system resources](#system-resources).
4.  If [`[[ImageTrackList]]`](#dom-imagedecoder-imagetracklist-slot) is empty, reject [`[[ready promise]]`](#dom-imagetracklist-ready-promise-slot) with exception. Otherwise perform these steps,
    1.  Remove all entries from [`[[ImageTrackList]]`](#dom-imagedecoder-imagetracklist-slot).
    2.  Assign `-1` to [`[[ImageTrackList]]`](#dom-imagedecoder-imagetracklist-slot)’s [`[[selected index]]`](#dom-imagetracklist-selected-index-slot).

5.  If [`[[complete]]`](#dom-imagedecoder-complete-slot) is false resolve [`[[completed promise]]`](#dom-imagedecoder-completed-promise-slot) with exception.

---

[← Back to 10.2. ImageDecoder Interface](../../10-image-decoding/10.2-imagedecoder-interface/TOC.md)
