# 6.6. Algorithms

**Schedule Dequeue Event**
: 1. If [`[[dequeue event scheduled]]`](#dom-videoencoder-dequeue-event-scheduled-slot) equals `true`, return.

2.  Assign `true` to [`[[dequeue event scheduled]]`](#dom-videoencoder-dequeue-event-scheduled-slot).
3.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
    1.  Fire a simple event named [`dequeue`](#eventdef-videoencoder-dequeue) at [this](https://webidl.spec.whatwg.org/#this).
    2.  Assign `false` to [`[[dequeue event scheduled]]`](#dom-videoencoder-dequeue-event-scheduled-slot).

**Output EncodedVideoChunks (with outputs)**
: Run these steps:

1.  For each output in outputs:
    1.  Let chunkInit be an [`EncodedVideoChunkInit`](#dictdef-encodedvideochunkinit) with the following keys:
        1.  Let [`data`](#dom-encodedvideochunkinit-data) contain the encoded video data from output.
        2.  Let [`type`](#dom-encodedvideochunkinit-type) be the [`EncodedVideoChunkType`](#enumdef-encodedvideochunktype) of output.
        3.  Let [`timestamp`](#dom-encodedvideochunkinit-timestamp) be the [`[[timestamp]]`](#dom-videoframe-timestamp-slot) from the [`VideoFrame`](#videoframe) associated with output.
        4.  Let [`duration`](#dom-encodedvideochunkinit-duration) be the [`[[duration]]`](#dom-videoframe-duration-slot) from the [`VideoFrame`](#videoframe) associated with output.

    2.  Let chunk be a new [`EncodedVideoChunk`](#encodedvideochunk) constructed with chunkInit.
    3.  Let chunkMetadata be a new [`EncodedVideoChunkMetadata`](#dictdef-encodedvideochunkmetadata).
    4.  Let encoderConfig be the [`[[active encoder config]]`](#dom-videoencoder-active-encoder-config-slot).
    5.  Let outputConfig be a [`VideoDecoderConfig`](#dictdef-videodecoderconfig) that describes output. Initialize outputConfig as follows:
        1.  Assign `encoderConfig.codec` to `outputConfig.codec`.
        2.  Assign `encoderConfig.width` to `outputConfig.codedWidth`.
        3.  Assign `encoderConfig.height` to `outputConfig.codedHeight`.
        4.  Assign `encoderConfig.displayWidth` to `outputConfig.displayAspectWidth`.
        5.  Assign `encoderConfig.displayHeight` to `outputConfig.displayAspectHeight`.
        6.  Assign [`[[rotation]]`](#dom-videoframe-rotation-slot) from the [`VideoFrame`](#videoframe) associated with output to `outputConfig.rotation`.
        7.  Assign [`[[flip]]`](#dom-videoframe-flip-slot) from the [`VideoFrame`](#videoframe) associated with output to `outputConfig.flip`.
        8.  Assign the remaining keys of `outputConfig` as determined by [`[[codec implementation]]`](#dom-videoencoder-codec-implementation-slot). The User Agent _MUST_ ensure that the configuration is completely described such that outputConfig could be used to correctly decode output.

            NOTE: The codec specific requirements for populating the [`description`](#dom-videodecoderconfig-description) are described in the [\[WEBCODECS-CODEC-REGISTRY\]](#biblio-webcodecs-codec-registry 'WebCodecs Codec Registry').

    6.  If outputConfig and [`[[active output config]]`](#dom-videoencoder-active-output-config-slot) are not [equal dictionaries](#equal-dictionaries):
        1.  Assign outputConfig to chunkMetadata.[`decoderConfig`](#dom-encodedvideochunkmetadata-decoderconfig).
        2.  Assign outputConfig to [`[[active output config]]`](#dom-videoencoder-active-output-config-slot).

    7.  If encoderConfig.[`scalabilityMode`](#dom-videoencoderconfig-scalabilitymode) describes multiple [temporal layers](#temporal-layer):
        1.  Let svc be a new [`SvcOutputMetadata`](#dictdef-svcoutputmetadata) instance.
        2.  Let temporal_layer_id be the zero-based index describing the temporal layer for output.
        3.  Assign temporal_layer_id to svc.[`temporalLayerId`](#dom-svcoutputmetadata-temporallayerid).
        4.  Assign svc to chunkMetadata.[`svc`](#dom-encodedvideochunkmetadata-svc).

    8.  If encoderConfig.[`alpha`](#dom-videoencoderconfig-alpha) is set to `"keep"`:
        1.  Let alphaSideData be the encoded alpha data in output.
        2.  Assign alphaSideData to chunkMetadata.[`alphaSideData`](#dom-encodedvideochunkmetadata-alphasidedata).

    9.  Invoke [`[[output callback]]`](#dom-videoencoder-output-callback-slot) with chunk and chunkMetadata.

**Reset VideoEncoder (with exception)**
: Run these steps:

1.  If [`[[state]]`](#dom-videoencoder-state-slot) is `"closed"`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror).
2.  Set [`[[state]]`](#dom-videoencoder-state-slot) to `"unconfigured"`.
3.  Set [`[[active encoder config]]`](#dom-videoencoder-active-encoder-config-slot) to `null`.
4.  Set [`[[active output config]]`](#dom-videoencoder-active-output-config-slot) to `null`.
5.  Signal [`[[codec implementation]]`](#dom-videoencoder-codec-implementation-slot) to cease producing output for the previous configuration.
6.  Remove all [control messages](#control-message) from the [`[[control message queue]]`](#dom-videoencoder-control-message-queue-slot).
7.  If [`[[encodeQueueSize]]`](#dom-videoencoder-encodequeuesize-slot) is greater than zero:
    1.  Set [`[[encodeQueueSize]]`](#dom-videoencoder-encodequeuesize-slot) to zero.
    2.  Run the [Schedule Dequeue Event](#videoencoder-schedule-dequeue-event) algorithm.

8.  For each promise in [`[[pending flush promises]]`](#dom-videoencoder-pending-flush-promises-slot):
    1.  Reject promise with exception.
    2.  Remove promise from [`[[pending flush promises]]`](#dom-videoencoder-pending-flush-promises-slot).

**Close VideoEncoder (with exception)**
: Run these steps:

1.  Run the [Reset VideoEncoder](#reset-videoencoder) algorithm with exception.
2.  Set [`[[state]]`](#dom-videoencoder-state-slot) to `"closed"`.
3.  Clear [`[[codec implementation]]`](#dom-videoencoder-codec-implementation-slot) and release associated [system resources](#system-resources).
4.  If exception is not an [`AbortError`](https://webidl.spec.whatwg.org/#aborterror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException), invoke the [`[[error callback]]`](#dom-videoencoder-error-callback-slot) with exception.

---

[‚Üê Back to 6. VideoEncoder Interface](../6-videoencoder-interface/TOC.md)
