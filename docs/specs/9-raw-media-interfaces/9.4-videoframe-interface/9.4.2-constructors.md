# 9.4.2. Constructors

`VideoFrame(image, init)`

1.  [Check the usability of the image argument](https://html.spec.whatwg.org/multipage/canvas.html#check-the-usability-of-the-image-argument). If this throws an exception or returns bad, then throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
    
2.  If image [is not origin-clean](https://html.spec.whatwg.org/multipage/canvas.html#the-image-argument-is-not-origin-clean), then throw a [`SecurityError`](https://webidl.spec.whatwg.org/#securityerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
    
3.  Let frame be a new [`VideoFrame`](#videoframe).
    
4.  Switch on image:
    
    NOTE: Authors are encouraged to provide a meaningful timestamp unless it is implicitly provided by the [`CanvasImageSource`](https://html.spec.whatwg.org/multipage/canvas.html#canvasimagesource) at construction. Interfaces that consume [`VideoFrame`](#videoframe)s can rely on this value for timing decisions. For example, [`VideoEncoder`](#videoencoder) can use [`timestamp`](#dom-videoframe-timestamp) values to guide rate control (see [`framerate`](#dom-videoencoderconfig-framerate)).
    
    -   [`HTMLImageElement`](https://html.spec.whatwg.org/multipage/embedded-content.html#htmlimageelement)
        
    -   [`SVGImageElement`](https://www.w3.org/TR/SVG2/embedded.html#InterfaceSVGImageElement)
        
        1.  If [`timestamp`](#dom-videoframeinit-timestamp) does not [exist](https://infra.spec.whatwg.org/#map-exists) in init, throw a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
            
        2.  If image’s media data has no [natural dimensions](https://www.w3.org/TR/css-images-3/#natural-dimensions) (e.g., it’s a vector graphic with no specified content size), then throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
            
        3.  Let resource be a new [media resource](#media-resource) containing a copy of image’s media data. If this is an animated image, image’s [bitmap data](https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#concept-imagebitmap-bitmap-data) _MUST_ only be taken from the default image of the animation (the one that the format defines is to be used when animation is not supported or is disabled), or, if there is no such image, the first frame of the animation.
            
        4.  Let codedWidth and codedHeight be the width and height of resource.
            
        5.  Let baseRotation and baseFlip describe the rotation and flip of image relative to resource.
            
        6.  Let defaultDisplayWidth and defaultDisplayHeight be the [natural width](https://www.w3.org/TR/css-images-3/#natural-width) and [natural height](https://www.w3.org/TR/css-images-3/#natural-height) of image.
            
        7.  Run the [Initialize Frame With Resource](#videoframe-initialize-frame-with-resource) algorithm with init, frame, resource, codedWidth, codedHeight, baseRotation, baseFlip, defaultDisplayWidth, and defaultDisplayHeight.
            
    -   [`HTMLVideoElement`](https://html.spec.whatwg.org/multipage/media.html#htmlvideoelement)
        
        1.  If image’s [`networkState`](https://html.spec.whatwg.org/multipage/media.html#dom-media-networkstate) attribute is [`NETWORK_EMPTY`](https://html.spec.whatwg.org/multipage/media.html#dom-media-network_empty), then throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
            
        2.  Let currentPlaybackFrame be the [`VideoFrame`](#videoframe) at the [current playback position](https://html.spec.whatwg.org/multipage/media.html#current-playback-position).
            
        3.  If [`metadata`](#dom-videoframeinit-metadata) does not [exist](https://infra.spec.whatwg.org/#map-exists) in init, assign currentPlaybackFrame.[`[[metadata]]`](#dom-videoframe-metadata-slot) to it.
            
        4.  Run the [Initialize Frame From Other Frame](#videoframe-initialize-frame-from-other-frame) algorithm with init, frame, and currentPlaybackFrame.
            
    -   [`HTMLCanvasElement`](https://html.spec.whatwg.org/multipage/canvas.html#htmlcanvaselement)
        
    -   [`ImageBitmap`](https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#imagebitmap)
        
    -   [`OffscreenCanvas`](https://html.spec.whatwg.org/multipage/canvas.html#offscreencanvas)
        
        1.  If [`timestamp`](#dom-videoframeinit-timestamp) does not [exist](https://infra.spec.whatwg.org/#map-exists) in init, throw a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
            
        2.  Let resource be a new [media resource](#media-resource) containing a copy of image’s [bitmap data](https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#concept-imagebitmap-bitmap-data).
            
            NOTE: Implementers are encouraged to avoid a deep copy by using reference counting where feasible.
            
        3.  Let width be `image.width` and height be `image.height`.
            
        4.  Run the [Initialize Frame With Resource](#videoframe-initialize-frame-with-resource) algorithm with init, frame, resource, width, height, `0`, `false`, width, and height.
            
    -   [`VideoFrame`](#videoframe)
        
        1.  Run the [Initialize Frame From Other Frame](#videoframe-initialize-frame-from-other-frame) algorithm with init, frame, and image.
            
5.  Return frame.
    

`VideoFrame(data, init)`

1.  If init is not a [valid VideoFrameBufferInit](#valid-videoframebufferinit), throw a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
    
2.  Let defaultRect be «\[ "x:" → `0`, "y" → `0`, "width" → init.[`codedWidth`](#dom-videoframebufferinit-codedwidth), "height" → init.[`codedWidth`](#dom-videoframebufferinit-codedwidth) \]».
    
3.  Let overrideRect be `undefined`.
    
4.  If init.[`visibleRect`](#dom-videoframebufferinit-visiblerect) [exists](https://infra.spec.whatwg.org/#map-exists), assign its value to overrideRect.
    
5.  Let parsedRect be the result of running the [Parse Visible Rect](#videoframe-parse-visible-rect) algorithm with defaultRect, overrideRect, init.[`codedWidth`](#dom-videoframebufferinit-codedwidth), init.[`codedHeight`](#dom-videoframebufferinit-codedheight), and init.[`format`](#dom-videoframebufferinit-format).
    
6.  If parsedRect is an exception, return parsedRect.
    
7.  Let optLayout be `undefined`.
    
8.  If init.[`layout`](#dom-videoframebufferinit-layout) [exists](https://infra.spec.whatwg.org/#map-exists), assign its value to optLayout.
    
9.  Let combinedLayout be the result of running the [Compute Layout and Allocation Size](#videoframe-compute-layout-and-allocation-size) algorithm with parsedRect, init.[`format`](#dom-videoframebufferinit-format), and optLayout.
    
10.  If combinedLayout is an exception, throw combinedLayout.
     
11.  If `data.byteLength` is less than combinedLayout’s [allocationSize](#combined-buffer-layout-allocationsize), throw a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
     
12.  If init.[`transfer`](#dom-videoframebufferinit-transfer) contains more than one reference to the same [`ArrayBuffer`](https://webidl.spec.whatwg.org/#idl-ArrayBuffer), then throw a [`DataCloneError`](https://webidl.spec.whatwg.org/#datacloneerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
     
13.  For each transferable in init.[`transfer`](#dom-videoframebufferinit-transfer):
     
     1.  If [`[[Detached]]`](https://html.spec.whatwg.org/multipage/structured-data.html#detached) internal slot is `true`, then throw a [`DataCloneError`](https://webidl.spec.whatwg.org/#datacloneerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
         
14.  If init.[`transfer`](#dom-videoframebufferinit-transfer) contains an [`ArrayBuffer`](https://webidl.spec.whatwg.org/#idl-ArrayBuffer) referenced by data the User Agent _MAY_ choose to:
     
     1.  Let resource be a new [media resource](#media-resource) referencing pixel data in data.
         
15.  Otherwise:
     
     1.  Let resource be a new [media resource](#media-resource) containing a copy of data. Use [`visibleRect`](#dom-videoframebufferinit-visiblerect) and [`layout`](#dom-videoframebufferinit-layout) to determine where in data the pixels for each plane reside.
         
         The User Agent _MAY_ choose to allocate resource with a larger coded size and plane strides to improve memory alignment. Increases will be reflected by [`codedWidth`](#dom-videoframe-codedwidth) and [`codedHeight`](#dom-videoframe-codedheight). Additionally, the User Agent _MAY_ use [`visibleRect`](#dom-videoframebufferinit-visiblerect) to copy only the visible rectangle. It _MAY_ also reposition the visible rectangle within resource. The final position will be reflected by [`visibleRect`](#dom-videoframe-visiblerect).
         
16.  For each transferable in init.[`transfer`](#dom-videoframebufferinit-transfer):
     
     1.  Perform [DetachArrayBuffer](https://tc39.es/ecma262/#sec-detacharraybuffer) on transferable
         
17.  Let resourceCodedWidth be the coded width of resource.
     
18.  Let resourceCodedHeight be the coded height of resource.
     
19.  Let resourceVisibleLeft be the left offset for the visible rectangle of resource.
     
20.  Let resourceVisibleTop be the top offset for the visible rectangle of resource.
     
     [](#issue-4948f268)The spec _SHOULD_ provide definitions (and possibly diagrams) for coded size, visible rectangle, and display size. See [#166](https://github.com/w3c/webcodecs/issues/166).
     
21.  Let frame be a new [`VideoFrame`](#videoframe) object initialized as follows:
     
     1.  Assign resourceCodedWidth, resourceCodedHeight, resourceVisibleLeft, and resourceVisibleTop to [`[[coded width]]`](#dom-videoframe-coded-width-slot), [`[[coded height]]`](#dom-videoframe-coded-height-slot), [`[[visible left]]`](#dom-videoframe-visible-left-slot), and [`[[visible top]]`](#dom-videoframe-visible-top-slot) respectively.
         
     2.  If init.[`visibleRect`](#dom-videoframebufferinit-visiblerect) [exists](https://infra.spec.whatwg.org/#map-exists):
         
         1.  Let truncatedVisibleWidth be the value of [`visibleRect`](#dom-videoframebufferinit-visiblerect).[`width`](https://www.w3.org/TR/geometry-1/#dom-domrectinit-width) after truncating.
             
         2.  Assign truncatedVisibleWidth to [`[[visible width]]`](#dom-videoframe-visible-width-slot).
             
         3.  Let truncatedVisibleHeight be the value of [`visibleRect`](#dom-videoframebufferinit-visiblerect).[`height`](https://www.w3.org/TR/geometry-1/#dom-domrectinit-height) after truncating.
             
         4.  Assign truncatedVisibleHeight to [`[[visible height]]`](#dom-videoframe-visible-height-slot).
             
     3.  Otherwise:
         
         1.  Assign [`[[coded width]]`](#dom-videoframe-coded-width-slot) to [`[[visible width]]`](#dom-videoframe-visible-width-slot).
             
         2.  Assign [`[[coded height]]`](#dom-videoframe-coded-height-slot) to [`[[visible height]]`](#dom-videoframe-visible-height-slot).
             
     4.  Assign the result of running the [Parse Rotation](#videoframe-parse-rotation) algorithm, with init.[`rotation`](#dom-videoframebufferinit-rotation), to [`[[rotation]]`](#dom-videoframe-rotation-slot).
         
     5.  Assign init.[`flip`](#dom-videoframebufferinit-flip) to [`[[flip]]`](#dom-videoframe-flip-slot).
         
     6.  If [`displayWidth`](#dom-videoframebufferinit-displaywidth) and [`displayHeight`](#dom-videoframebufferinit-displayheight) [exist](https://infra.spec.whatwg.org/#map-exists) in init, assign them to [`[[display width]]`](#dom-videoframe-display-width-slot) and [`[[display height]]`](#dom-videoframe-display-height-slot) respectively.
         
     7.  Otherwise:
         
         1.  If [`[[rotation]]`](#dom-videoframe-rotation-slot) is equal to `0` or `180`:
             
             1.  Assign [`[[visible width]]`](#dom-videoframe-visible-width-slot) to [`[[display width]]`](#dom-videoframe-display-width-slot).
                 
             2.  Assign [`[[visible height]]`](#dom-videoframe-visible-height-slot) to [`[[display height]]`](#dom-videoframe-display-height-slot).
                 
         2.  Otherwise:
             
             1.  Assign [`[[visible height]]`](#dom-videoframe-visible-height-slot) to [`[[display width]]`](#dom-videoframe-display-width-slot).
                 
             2.  Assign [`[[visible width]]`](#dom-videoframe-visible-width-slot) to [`[[display height]]`](#dom-videoframe-display-height-slot).
                 
     8.  Assign init’s [`timestamp`](#dom-videoframebufferinit-timestamp) and [`duration`](#dom-videoframebufferinit-duration) to [`[[timestamp]]`](#dom-videoframe-timestamp-slot) and [`[[duration]]`](#dom-videoframe-duration-slot) respectively.
         
     9.  Let colorSpace be `undefined`.
         
     10.  If init.[`colorSpace`](#dom-videoframebufferinit-colorspace) [exists](https://infra.spec.whatwg.org/#map-exists), assign its value to colorSpace.
          
     11.  Assign init’s [`format`](#dom-videoframebufferinit-format) to [`[[format]]`](#dom-videoframe-format-slot).
          
     12.  Assign the result of running the [Pick Color Space](#videoframe-pick-color-space) algorithm, with colorSpace and [`[[format]]`](#dom-videoframe-format-slot), to [`[[color space]]`](#dom-videoframe-color-space-slot).
          
     13.  Assign the result of calling [Copy VideoFrame metadata](#videoframe-copy-videoframe-metadata) with init’s [`metadata`](#dom-videoframebufferinit-metadata) to frame.[`[[metadata]]`](#dom-videoframe-metadata-slot).
          
22.  Return frame.

---

[← Back to 9.4. VideoFrame Interface](../../9-raw-media-interfaces/9.4-videoframe-interface/TOC.md)
