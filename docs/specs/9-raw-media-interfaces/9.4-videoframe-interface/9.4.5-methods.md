# 9.4.5. Methods

**allocationSize(options)**
: Returns the minimum byte length for a valid destination [`BufferSource`](https://webidl.spec.whatwg.org/#BufferSource) to be used with [`copyTo()`](#dom-videoframe-copyto) with the given options.

When invoked, run these steps:

1.  If [`[[Detached]]`](https://html.spec.whatwg.org/multipage/structured-data.html#detached) is `true`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
2.  If [`[[format]]`](#dom-videoframe-format-slot) is `null`, throw a [`NotSupportedError`](https://webidl.spec.whatwg.org/#notsupportederror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
3.  Let combinedLayout be the result of running the [Parse VideoFrameCopyToOptions](#videoframe-parse-videoframecopytooptions) algorithm with options.
4.  If combinedLayout is an exception, throw combinedLayout.
5.  Return combinedLayout’s [allocationSize](#combined-buffer-layout-allocationsize).

**copyTo(destination, options)**
: Asynchronously copies the planes of this frame into destination according to options. The format of the data is options.[`format`](#dom-videoframecopytooptions-format), if it [exists](https://infra.spec.whatwg.org/#map-exists) or [this](https://webidl.spec.whatwg.org/#this) [`VideoFrame`](#videoframe)’s [`format`](#dom-videoframe-format) otherwise.

NOTE: Promises that are returned by several calls to [`copyTo()`](#dom-videoframe-copyto) are not guaranteed to resolve in the order they were returned.

When invoked, run these steps:

1.  If [`[[Detached]]`](https://html.spec.whatwg.org/multipage/structured-data.html#detached) is `true`, return a promise rejected with a [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
2.  If [`[[format]]`](#dom-videoframe-format-slot) is `null`, return a promise rejected with a [`NotSupportedError`](https://webidl.spec.whatwg.org/#notsupportederror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
3.  Let combinedLayout be the result of running the [Parse VideoFrameCopyToOptions](#videoframe-parse-videoframecopytooptions) algorithm with options.
4.  If combinedLayout is an exception, return a promise rejected with combinedLayout.
5.  If `destination.byteLength` is less than combinedLayout’s [allocationSize](#combined-buffer-layout-allocationsize), return a promise rejected with a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
6.  If options.[`format`](#dom-videoframecopytooptions-format) is equal to one of [`RGBA`](#dom-videopixelformat-rgba), [`RGBX`](#dom-videopixelformat-rgbx), [`BGRA`](#dom-videopixelformat-bgra), [`BGRX`](#dom-videopixelformat-bgrx) then:
    1.  Let newOptions be the result of running the [Clone Configuration](#clone-configuration) algorithm with options.
    2.  Assign `undefined` to newOptions.[`format`](#dom-videoframecopytooptions-format).
    3.  Let rgbFrame be the result of running the [Convert to RGB frame](#videoframe-convert-to-rgb-frame) algorithm with [this](https://webidl.spec.whatwg.org/#this), options.[`format`](#dom-videoframecopytooptions-format), and options.[`colorSpace`](#dom-videoframecopytooptions-colorspace).
    4.  Return the result of calling [`copyTo()`](#dom-videoframe-copyto) on rgbFrame with destination and newOptions.

7.  Let p be a new [`Promise`](https://webidl.spec.whatwg.org/#idl-promise).
8.  Let copyStepsQueue be the result of starting a new [parallel queue](https://html.spec.whatwg.org/multipage/infrastructure.html#parallel-queue).
9.  Let planeLayouts be a new [list](https://infra.spec.whatwg.org/#list).
10. Enqueue the following steps to copyStepsQueue:
    1.  Let resource be the [media resource](#media-resource) referenced by [`[[resource reference]]`](#dom-videoframe-resource-reference-slot).
    2.  Let numPlanes be the number of planes as defined by [`[[format]]`](#dom-videoframe-format-slot).
    3.  Let planeIndex be `0`.
    4.  While planeIndex is less than combinedLayout’s numPlanes:
        1.  Let sourceStride be the stride of the plane in resource as identified by planeIndex.
        2.  Let computedLayout be the [computed plane layout](#computed-plane-layout) in combinedLayout’s [computedLayouts](#combined-buffer-layout-computedlayouts) at the position of planeIndex
        3.  Let sourceOffset be the product of multiplying computedLayout’s [sourceTop](#computed-plane-layout-sourcetop) by sourceStride
        4.  Add computedLayout’s [sourceLeftBytes](#computed-plane-layout-sourceleftbytes) to sourceOffset.
        5.  Let destinationOffset be computedLayout’s [destinationOffset](#computed-plane-layout-destinationoffset).
        6.  Let rowBytes be computedLayout’s [sourceWidthBytes](#computed-plane-layout-sourcewidthbytes).
        7.  Let layout be a new [`PlaneLayout`](#dictdef-planelayout), with [`offset`](#dom-planelayout-offset) set to destinationOffset and [`stride`](#dom-planelayout-stride) set to rowBytes.
        8.  Let row be `0`.
        9.  While row is less than computedLayout’s [sourceHeight](#computed-plane-layout-sourceheight):
            1.  Copy rowBytes bytes from resource starting at sourceOffset to destination starting at destinationOffset.
            2.  Increment sourceOffset by sourceStride.
            3.  Increment destinationOffset by computedLayout’s [destinationStride](#computed-plane-layout-destinationstride).
            4.  Increment row by `1`.

        10. Increment planeIndex by `1`.
        11. Append layout to planeLayouts.

    5.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to resolve p with planeLayouts.

11. Return p.

**clone()**
: Creates a new [`VideoFrame`](#videoframe) with a reference to the same [media resource](#media-resource).

When invoked, run these steps:

1.  If the value of frame’s [`[[Detached]]`](https://html.spec.whatwg.org/multipage/structured-data.html#detached) internal slot is `true`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
2.  Return the result of running the [Clone VideoFrame](#clone-videoframe) algorithm with [this](https://webidl.spec.whatwg.org/#this).

**close()**
: Clears all state and releases the reference to the [media resource](#media-resource). Close is final.

When invoked, run the [Close VideoFrame](#close-videoframe) algorithm with [this](https://webidl.spec.whatwg.org/#this).

**metadata()**
: Gets the [`VideoFrameMetadata`](#dictdef-videoframemetadata) associated with this frame.

When invoked, run these steps:

1.  If [`[[Detached]]`](https://html.spec.whatwg.org/multipage/structured-data.html#detached) is `true`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
2.  Return the result of calling [Copy VideoFrame metadata](#videoframe-copy-videoframe-metadata) with [`[[metadata]]`](#dom-videoframe-metadata-slot).

---

[← Back to 9.4. VideoFrame Interface](../../9-raw-media-interfaces/9.4-videoframe-interface/TOC.md)
