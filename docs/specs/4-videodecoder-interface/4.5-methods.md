# 4.5. Methods

**configure(config)**
: [Enqueues a control message](#enqueues-a-control-message) to configure the video decoder for decoding chunks as described by config.

NOTE: This method will trigger a [`NotSupportedError`](https://webidl.spec.whatwg.org/#notsupportederror) if the User Agent does not support config. Authors are encouraged to first check support by calling [`isConfigSupported()`](#dom-videodecoder-isconfigsupported) with config. User Agents don’t have to support any particular codec type or configuration.

When invoked, run these steps:

1.  If config is not a [valid VideoDecoderConfig](#valid-videodecoderconfig), throw a [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
2.  If [`[[state]]`](#dom-videodecoder-state-slot) is `“closed”`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror).
3.  Set [`[[state]]`](#dom-videodecoder-state-slot) to `"configured"`.
4.  Set [`[[key chunk required]]`](#dom-videodecoder-key-chunk-required-slot) to `true`.
5.  [Queue a control message](#enqueues-a-control-message) to configure the decoder with config.
6.  [Process the control message queue](#process-the-control-message-queue).

[Running a control message](#running-a-control-message) to configure the decoder means running these steps:

1.  Assign `true` to [`[[message queue blocked]]`](#dom-videodecoder-message-queue-blocked-slot).
2.  Enqueue the following steps to [`[[codec work queue]]`](#dom-videodecoder-codec-work-queue-slot):
    1.  Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
    2.  If supported is `false`, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close VideoDecoder](#close-videodecoder) algorithm with [`NotSupportedError`](https://webidl.spec.whatwg.org/#notsupportederror) and abort these steps.
    3.  If needed, assign [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) with an implementation supporting config.
    4.  Configure [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) with config.
    5.  [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
        1.  Assign `false` to [`[[message queue blocked]]`](#dom-videodecoder-message-queue-blocked-slot).
        2.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to [Process the control message queue](#process-the-control-message-queue).

3.  Return `"processed"`.

**decode(chunk)**
: [Enqueues a control message](#enqueues-a-control-message) to decode the given chunk.

NOTE: Authors are encouraged to call [`close()`](#dom-videoframe-close) on output [`VideoFrame`](#videoframe)s immediately when frames are no longer needed. The underlying [media resource](#media-resource)s are owned by the [`VideoDecoder`](#videodecoder) and failing to release them (or waiting for garbage collection) can cause decoding to stall.

NOTE: [`VideoDecoder`](#videodecoder) requires that frames are output in the order they expect to be presented, commonly known as presentation order. When using some [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot)s the User Agent will have to reorder outputs into presentation order.

When invoked, run these steps:

1.  If [`[[state]]`](#dom-videodecoder-state-slot) is not `"configured"`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror).
2.  If [`[[key chunk required]]`](#dom-videodecoder-key-chunk-required-slot) is `true`:
    1.  If chunk.[`type`](#dom-encodedvideochunk-type) is not [`key`](#dom-encodedvideochunktype-key), throw a [`DataError`](https://webidl.spec.whatwg.org/#dataerror).
    2.  Implementers _SHOULD_ inspect the chunk’s [`[[internal data]]`](#dom-encodedvideochunk-internal-data-slot) to verify that it is truly a [key chunk](#key-chunk). If a mismatch is detected, throw a [`DataError`](https://webidl.spec.whatwg.org/#dataerror).
    3.  Otherwise, assign `false` to [`[[key chunk required]]`](#dom-videodecoder-key-chunk-required-slot).

3.  Increment [`[[decodeQueueSize]]`](#dom-videodecoder-decodequeuesize-slot).
4.  [Queue a control message](#enqueues-a-control-message) to decode the chunk.
5.  [Process the control message queue](#process-the-control-message-queue).

[Running a control message](#running-a-control-message) to decode the chunk means performing these steps:

1.  If [`[[codec saturated]]`](#dom-videodecoder-codec-saturated-slot) equals `true`, return `"not processed"`.
2.  If decoding chunk will cause the [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) to become [saturated](#saturated), assign `true` to [`[[codec saturated]]`](#dom-videodecoder-codec-saturated-slot).
3.  Decrement [`[[decodeQueueSize]]`](#dom-videodecoder-decodequeuesize-slot) and run the [Schedule Dequeue Event](#videodecoder-schedule-dequeue-event) algorithm.
4.  Enqueue the following steps to the [`[[codec work queue]]`](#dom-videodecoder-codec-work-queue-slot):
    1.  Attempt to use [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) to decode the chunk.
    2.  If decoding results in an error, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close VideoDecoder](#close-videodecoder) algorithm with [`EncodingError`](https://webidl.spec.whatwg.org/#encodingerror) and return.
    3.  If [`[[codec saturated]]`](#dom-videodecoder-codec-saturated-slot) equals `true` and [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) is no longer [saturated](#saturated), [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform the following steps:
        1.  Assign `false` to [`[[codec saturated]]`](#dom-videodecoder-codec-saturated-slot).
        2.  [Process the control message queue](#process-the-control-message-queue).

    4.  Let decoded outputs be a [list](https://infra.spec.whatwg.org/#list) of decoded video data outputs emitted by [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) in presentation order.
    5.  If decoded outputs is not empty, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Output VideoFrame](#output-videoframes) algorithm with decoded outputs.

5.  Return `"processed"`.

**flush()**
: Completes all [control messages](#control-message) in the [control message queue](#control-message-queue) and emits all outputs.

When invoked, run these steps:

1.  If [`[[state]]`](#dom-videodecoder-state-slot) is not `"configured"`, return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).
2.  Set [`[[key chunk required]]`](#dom-videodecoder-key-chunk-required-slot) to `true`.
3.  Let promise be a new Promise.
4.  Append promise to [`[[pending flush promises]]`](#dom-videodecoder-pending-flush-promises-slot).
5.  [Queue a control message](#enqueues-a-control-message) to flush the codec with promise.
6.  [Process the control message queue](#process-the-control-message-queue).
7.  Return promise.

[Running a control message](#running-a-control-message) to flush the codec means performing these steps with promise.

1.  Enqueue the following steps to the [`[[codec work queue]]`](#dom-videodecoder-codec-work-queue-slot):
    1.  Signal [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) to emit all [internal pending outputs](#internal-pending-output).
    2.  Let decoded outputs be a [list](https://infra.spec.whatwg.org/#list) of decoded video data outputs emitted by [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot).
    3.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform these steps:
        1.  If decoded outputs is not empty, run the [Output VideoFrame](#output-videoframes) algorithm with decoded outputs.
        2.  Remove promise from [`[[pending flush promises]]`](#dom-videodecoder-pending-flush-promises-slot).
        3.  Resolve promise.

2.  Return `"processed"`.

**reset()**
: Immediately resets all state including configuration, [control messages](#control-message) in the [control message queue](#control-message-queue), and all pending callbacks.

When invoked, run the [Reset VideoDecoder](#reset-videodecoder) algorithm with an [`AbortError`](https://webidl.spec.whatwg.org/#aborterror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).

**close()**
: Immediately aborts all pending work and releases [system resources](#system-resources). Close is final.

When invoked, run the [Close VideoDecoder](#close-videodecoder) algorithm with an [`AbortError`](https://webidl.spec.whatwg.org/#aborterror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException).

**isConfigSupported(config)**
: Returns a promise indicating whether the provided config is supported by the User Agent.

NOTE: The returned [`VideoDecoderSupport`](#dictdef-videodecodersupport) [`config`](#dom-videodecodersupport-config) will contain only the dictionary members that User Agent recognized. Unrecognized dictionary members will be ignored. Authors can detect unrecognized dictionary members by comparing [`config`](#dom-videodecodersupport-config) to their provided config.

When invoked, run these steps:

1.  If config is not a [valid VideoDecoderConfig](#valid-videodecoderconfig), return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) [`TypeError`](https://webidl.spec.whatwg.org/#exceptiondef-typeerror).
2.  Let p be a new Promise.
3.  Let checkSupportQueue be the result of starting a new [parallel queue](https://html.spec.whatwg.org/multipage/infrastructure.html#parallel-queue).
4.  Enqueue the following steps to checkSupportQueue:
    1.  Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
    2.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
        1.  Let decoderSupport be a newly constructed [`VideoDecoderSupport`](#dictdef-videodecodersupport), initialized as follows:
            1.  Set [`config`](#dom-videodecodersupport-config) to the result of running the [Clone Configuration](#clone-configuration) algorithm with config.
            2.  Set [`supported`](#dom-videodecodersupport-supported) to supported.

        2.  Resolve p with decoderSupport.

5.  Return p.

---

[← Back to 4. VideoDecoder Interface](../4-videodecoder-interface/TOC.md)
