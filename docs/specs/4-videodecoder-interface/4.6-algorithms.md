# 4.6. Algorithms

**Schedule Dequeue Event**
: 1.  If [`[[dequeue event scheduled]]`](#dom-videodecoder-dequeue-event-scheduled-slot) equals `true`, return.
    
2.  Assign `true` to [`[[dequeue event scheduled]]`](#dom-videodecoder-dequeue-event-scheduled-slot).
    
3.  [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
    
    1.  Fire a simple event named [`dequeue`](#eventdef-videodecoder-dequeue) at [this](https://webidl.spec.whatwg.org/#this).
        
    2.  Assign `false` to [`[[dequeue event scheduled]]`](#dom-videodecoder-dequeue-event-scheduled-slot).

**Output VideoFrames (with outputs)**
: Run these steps:

1.  For each output in outputs:
    
    1.  Let timestamp and duration be the [`timestamp`](#dom-encodedvideochunk-timestamp) and [`duration`](#dom-encodedvideochunk-duration) from the [`EncodedVideoChunk`](#encodedvideochunk) associated with output.
        
    2.  Let displayAspectWidth and displayAspectHeight be undefined.
        
    3.  If [`displayAspectWidth`](#dom-videodecoderconfig-displayaspectwidth) and [`displayAspectHeight`](#dom-videodecoderconfig-displayaspectheight) [exist](https://infra.spec.whatwg.org/#map-exists) in the [`[[active decoder config]]`](#dom-videodecoder-active-decoder-config-slot), assign their values to displayAspectWidth and displayAspectHeight respectively.
        
    4.  Let colorSpace be the [`VideoColorSpace`](#videocolorspace) for output as detected by the codec implementation. If no [`VideoColorSpace`](#videocolorspace) is detected, let colorSpace be `undefined`.
        
        NOTE: The codec implementation can detect a [`VideoColorSpace`](#videocolorspace) by analyzing the bitstream. Detection is made on a best-effort basis. The exact method of detection is implementer defined and codec-specific. Authors can override the detected [`VideoColorSpace`](#videocolorspace) by providing a [`colorSpace`](#dom-videodecoderconfig-colorspace) in the [`VideoDecoderConfig`](#dictdef-videodecoderconfig).
        
    5.  If [`colorSpace`](#dom-videodecoderconfig-colorspace) [exists](https://infra.spec.whatwg.org/#map-exists) in the [`[[active decoder config]]`](#dom-videodecoder-active-decoder-config-slot), assign its value to colorSpace.
        
    6.  Assign the values of [`rotation`](#dom-videodecoderconfig-rotation) and [`flip`](#dom-videodecoderconfig-flip) to rotation and flip respectively.
        
    7.  Let frame be the result of running the [Create a VideoFrame](#create-a-videoframe) algorithm with output, timestamp, duration, displayAspectWidth, displayAspectHeight, colorSpace, rotation, and flip.
        
    8.  Invoke [`[[output callback]]`](#dom-videodecoder-output-callback-slot) with frame.

**Reset VideoDecoder (with exception)**
: Run these steps:

1.  If [`state`](#dom-videodecoder-state) is `"closed"`, throw an [`InvalidStateError`](https://webidl.spec.whatwg.org/#invalidstateerror).
    
2.  Set [`state`](#dom-videodecoder-state) to `"unconfigured"`.
    
3.  Signal [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) to cease producing output for the previous configuration.
    
4.  Remove all [control messages](#control-message) from the [`[[control message queue]]`](#dom-videodecoder-control-message-queue-slot).
    
5.  If [`[[decodeQueueSize]]`](#dom-videodecoder-decodequeuesize-slot) is greater than zero:
    
    1.  Set [`[[decodeQueueSize]]`](#dom-videodecoder-decodequeuesize-slot) to zero.
        
    2.  Run the [Schedule Dequeue Event](#videodecoder-schedule-dequeue-event) algorithm.
        
6.  For each promise in [`[[pending flush promises]]`](#dom-videodecoder-pending-flush-promises-slot):
    
    1.  Reject promise with exception.
        
    2.  Remove promise from [`[[pending flush promises]]`](#dom-videodecoder-pending-flush-promises-slot).

**Close VideoDecoder (with exception)**
: Run these steps:

1.  Run the [Reset VideoDecoder](#reset-videodecoder) algorithm with exception.
    
2.  Set [`state`](#dom-videodecoder-state) to `"closed"`.
    
3.  Clear [`[[codec implementation]]`](#dom-videodecoder-codec-implementation-slot) and release associated [system resources](#system-resources).
    
4.  If exception is not an [`AbortError`](https://webidl.spec.whatwg.org/#aborterror) [`DOMException`](https://webidl.spec.whatwg.org/#idl-DOMException), invoke the [`[[error callback]]`](#dom-videodecoder-error-callback-slot) with exception.

---

[‚Üê Back to 4. VideoDecoder Interface](../4-videodecoder-interface/TOC.md)
