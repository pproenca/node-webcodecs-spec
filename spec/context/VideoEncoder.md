# VideoEncoder Specification

> **Source:** W3C WebCodecs (Auto-generated by scaffold-project.ts)

## Table of Contents

- [Description](#description)
- [Attributes](#attributes)
- [Methods](#methods)
  - [constructor](#constructor)
  - [configure](#configure)
  - [encode](#encode)
  - [flush](#flush)
  - [reset](#reset)
  - [close](#close)
  - [isConfigSupported](#isconfigsupported)


## Description

VideoEncoder interface from the W3C WebCodecs specification.

## Attributes

- **state** (`CodecState*`) [ReadOnly]
- **encodeQueueSize** (`uint32_t`) [ReadOnly]
- **ondequeue** (`EventHandler*`)

## Methods


### constructor

**Signature:** `constructor(VideoEncoderInit* init)`

**Algorithm:**

1. Initialize internal slots.


### configure

**Signature:** `void configure(VideoEncoderConfig* config)`

**Algorithm:**

1. [Enqueues a control message](#enqueues-a-control-message) to configure the video encoder for encoding video frames as described by config.
2. NOTE: This method will trigger a `[NotSupportedError](https://webidl.spec.whatwg.org/#notsupportederror)` if the User Agent does not support config. Authors are encouraged to first check support by calling `[isConfigSupported()](#dom-videoencoder-isconfigsupported)` with config. User Agents don’t have to support any particular codec type or configuration.
3. When invoked, run these steps:
1. If config is not a [valid VideoEncoderConfig](#valid-videoencoderconfig), throw a `[TypeError](https://webidl.spec.whatwg.org/#exceptiondef-typeerror)`.
2. If `[state](#dom-videoencoder-state-slot)` is "closed", throw an `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)`.
3. Set `[state](#dom-videoencoder-state-slot)` to "configured".
4. Set `[active orientation](#dom-videoencoder-active-orientation-slot)` to `null`.
5. [Queue a control message](#enqueues-a-control-message) to configure the encoder using config.
6. [Process the control message queue](#process-the-control-message-queue).
10. [Running a control message](#running-a-control-message) to configure the encoder means performing these steps:
1. Assign `true` to `[message queue blocked](#dom-videoencoder-message-queue-blocked-slot)`.
2. Enqueue the following steps to `[codec work queue](#dom-videoencoder-codec-work-queue-slot)`:
1. Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
2. If supported is `false`, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close VideoEncoder](#close-videoencoder) algorithm with `[NotSupportedError](https://webidl.spec.whatwg.org/#notsupportederror)` and abort these steps.
3. If needed, assign `[codec implementation](#dom-videoencoder-codec-implementation-slot)` with an implementation supporting config.
4. Configure `[codec implementation](#dom-videoencoder-codec-implementation-slot)` with config.
5. [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
1. Assign `false` to `[message queue blocked](#dom-videoencoder-message-queue-blocked-slot)`.
2. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to [Process the control message queue](#process-the-control-message-queue).
3. Return "processed".


### encode

**Signature:** `void encode(VideoFrame* frame, VideoEncoderEncodeOptions* options)`

**Algorithm:**

1. [Enqueues a control message](#enqueues-a-control-message) to encode the given frame.
2. When invoked, run these steps:
1. If the value of frame’s `[Detached](https://html.spec.whatwg.org/multipage/structured-data.html#detached)` internal slot is `true`, throw a `[TypeError](https://webidl.spec.whatwg.org/#exceptiondef-typeerror)`.
2. If `[state](#dom-videoencoder-state-slot)` is not "configured", throw an `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)`.
3. If `[active orientation](#dom-videoencoder-active-orientation-slot)` is not `null` and does not match frame’s `[rotation](#dom-videoframe-rotation-slot)` and `[flip](#dom-videoframe-flip-slot)` throw a `[DataError](https://webidl.spec.whatwg.org/#dataerror)`.
4. If `[active orientation](#dom-videoencoder-active-orientation-slot)` is `null`, set it to frame’s `[rotation](#dom-videoframe-rotation-slot)` and `[flip](#dom-videoframe-flip-slot)`.
5. Let frameClone hold the result of running the [Clone VideoFrame](#clone-videoframe) algorithm with frame.
6. Increment `[encodeQueueSize](#dom-videoencoder-encodequeuesize-slot)`.
7. [Queue a control message](#enqueues-a-control-message) to encode frameClone.
8. [Process the control message queue](#process-the-control-message-queue).
11. [Running a control message](#running-a-control-message) to encode the frame means performing these steps:
1. If `[codec saturated](#dom-videoencoder-codec-saturated-slot)` equals `true`, return "not processed".
2. If encoding frame will cause the `[codec implementation](#dom-videoencoder-codec-implementation-slot)` to become [saturated](#saturated), assign `true` to `[codec saturated](#dom-videoencoder-codec-saturated-slot)`.
3. Decrement `[encodeQueueSize](#dom-videoencoder-encodequeuesize-slot)` and run the [Schedule Dequeue Event](#videoencoder-schedule-dequeue-event) algorithm.
4. Enqueue the following steps to the `[codec work queue](#dom-videoencoder-codec-work-queue-slot)`:
1. Attempt to use `[codec implementation](#dom-videoencoder-codec-implementation-slot)` to encode the frameClone according to options.
2. If encoding results in an error, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close VideoEncoder](#close-videoencoder) algorithm with `[EncodingError](https://webidl.spec.whatwg.org/#encodingerror)` and return.
3. If `[codec saturated](#dom-videoencoder-codec-saturated-slot)` equals `true` and `[codec implementation](#dom-videoencoder-codec-implementation-slot)` is no longer [saturated](#saturated), [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform the following steps:
1. Assign `false` to `[codec saturated](#dom-videoencoder-codec-saturated-slot)`.
2. [Process the control message queue](#process-the-control-message-queue).
4. Let encoded outputs be a [list](https://infra.spec.whatwg.org/#list) of encoded video data outputs emitted by `[codec implementation](#dom-videoencoder-codec-implementation-slot)`.
5. If encoded outputs is not empty, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Output EncodedVideoChunks](#output-encodedvideochunks) algorithm with encoded outputs.
5. Return "processed".


### flush

**Signature:** `Napi::Value flush()`

**Algorithm:**

1. Completes all [control messages](#control-message) in the [control message queue](#control-message-queue) and emits all outputs.
2. When invoked, run these steps:
1. If `[state](#dom-videoencoder-state-slot)` is not "configured", return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.
2. Let promise be a new Promise.
3. Append promise to `[pending flush promises](#dom-videoencoder-pending-flush-promises-slot)`.
4. [Queue a control message](#enqueues-a-control-message) to flush the codec with promise.
5. [Process the control message queue](#process-the-control-message-queue).
6. Return promise.
9. [Running a control message](#running-a-control-message) to flush the codec means performing these steps with promise:
1. Enqueue the following steps to the `[codec work queue](#dom-videoencoder-codec-work-queue-slot)`:
1. Signal `[codec implementation](#dom-videoencoder-codec-implementation-slot)` to emit all [internal pending outputs](#internal-pending-output).
2. Let encoded outputs be a [list](https://infra.spec.whatwg.org/#list) of encoded video data outputs emitted by `[codec implementation](#dom-videoencoder-codec-implementation-slot)`.
3. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform these steps:
1. If encoded outputs is not empty, run the [Output EncodedVideoChunks](#output-encodedvideochunks) algorithm with encoded outputs.
2. Remove promise from `[pending flush promises](#dom-videoencoder-pending-flush-promises-slot)`.
3. Resolve promise.
2. Return "processed".


### reset

**Signature:** `void reset()`

**Algorithm:**

1. Immediately resets all state including configuration, [control messages](#control-message) in the [control message queue](#control-message-queue), and all pending callbacks.
2. When invoked, run the [Reset VideoEncoder](#reset-videoencoder) algorithm with an `[AbortError](https://webidl.spec.whatwg.org/#aborterror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.


### close

**Signature:** `void close()`

**Algorithm:**

1. Immediately aborts all pending work and releases [system resources](#system-resources). Close is final.
2. When invoked, run the [Close VideoEncoder](#close-videoencoder) algorithm with an `[AbortError](https://webidl.spec.whatwg.org/#aborterror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.


### isConfigSupported

**Static Method**

**Signature:** `Napi::Value isConfigSupported(VideoEncoderConfig* config)`

**Algorithm:**

1. Returns a promise indicating whether the provided config is supported by the User Agent.
2. NOTE: The returned `[VideoEncoderSupport](#dictdef-videoencodersupport)` `[config](#dom-videoencodersupport-config)` will contain only the dictionary members that User Agent recognized. Unrecognized dictionary members will be ignored. Authors can detect unrecognized dictionary members by comparing `[config](#dom-videoencodersupport-config)` to their provided config.
3. When invoked, run these steps:
1. If config is not a [valid VideoEncoderConfig](#valid-videoencoderconfig), return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) `[TypeError](https://webidl.spec.whatwg.org/#exceptiondef-typeerror)`.
2. Let p be a new Promise.
3. Let checkSupportQueue be the result of starting a new [parallel queue](https://html.spec.whatwg.org/multipage/infrastructure.html#parallel-queue).
4. Enqueue the following steps to checkSupportQueue:
1. Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
2. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
1. Let encoderSupport be a newly constructed `[VideoEncoderSupport](#dictdef-videoencodersupport)`, initialized as follows:
1. Set `[config](#dom-videoencodersupport-config)` to the result of running the [Clone Configuration](#clone-configuration) algorithm with config.
2. Set `[supported](#dom-videoencodersupport-supported)` to supported.
3. Resolve p with encoderSupport.
5. Return p.

