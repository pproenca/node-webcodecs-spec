# ImageDecoder Specification

> **Source:** W3C WebCodecs (Auto-generated by scaffold-project.ts)

## Table of Contents

- [Description](#description)
- [Attributes](#attributes)
- [Methods](#methods)
  - [constructor](#constructor)
  - [decode](#decode)
  - [reset](#reset)
  - [close](#close)
  - [isTypeSupported](#istypesupported)


## Description

ImageDecoder interface from the W3C WebCodecs specification.

## Attributes

- **type** (`std::string`) [ReadOnly]
- **complete** (`bool`) [ReadOnly]
- **completed** (`Napi::Value`) [ReadOnly]
- **tracks** (`ImageTrackList*`) [ReadOnly]

## Methods


### constructor

**Signature:** `constructor(ImageDecoderInit* init)`

**Algorithm:**

1. NOTE: Calling `[decode()](#dom-imagedecoder-decode)` on the constructed `[ImageDecoder](#imagedecoder)` will trigger a `[NotSupportedError](https://webidl.spec.whatwg.org/#notsupportederror)` if the User Agent does not support type. Authors are encouraged to first check support by calling `[isTypeSupported()](#dom-imagedecoder-istypesupported)` with type. User Agents don’t have to support any particular type.
2. When invoked, run these steps:
1. If init is not [valid ImageDecoderInit](#valid-imagedecoderinit), throw a `[TypeError](https://webidl.spec.whatwg.org/#exceptiondef-typeerror)`.
2. If init.`[transfer](#dom-imagedecoderinit-transfer)` contains more than one reference to the same `[ArrayBuffer](https://webidl.spec.whatwg.org/#idl-ArrayBuffer)`, then throw a `[DataCloneError](https://webidl.spec.whatwg.org/#datacloneerror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.
3. For each transferable in init.`[transfer](#dom-imagedecoderinit-transfer)`:
1. If `[Detached](https://html.spec.whatwg.org/multipage/structured-data.html#detached)` internal slot is `true`, then throw a `[DataCloneError](https://webidl.spec.whatwg.org/#datacloneerror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.
4. Let d be a new `[ImageDecoder](#imagedecoder)` object. In the steps below, all mentions of `[ImageDecoder](#imagedecoder)` members apply to d unless stated otherwise.
5. Assign a new [queue](https://infra.spec.whatwg.org/#queue) to `[control message queue](#dom-imagedecoder-control-message-queue-slot)`.
6. Assign `false` to `[message queue blocked](#dom-imagedecoder-message-queue-blocked-slot)`.
7. Assign the result of starting a new [parallel queue](https://html.spec.whatwg.org/multipage/infrastructure.html#parallel-queue) to `[codec work queue](#dom-imagedecoder-codec-work-queue-slot)`.
8. Assign `[ImageTrackList](#dom-imagedecoder-imagetracklist-slot)` a new `[ImageTrackList](#imagetracklist)` initialized as follows:
1. Assign a new [list](https://infra.spec.whatwg.org/#list) to `[track list](#dom-imagetracklist-track-list-slot)`.
2. Assign `-1` to `[selected index](#dom-imagetracklist-selected-index-slot)`.
9. Assign `[type](#dom-imagedecoderinit-type)` to `[type](#dom-imagedecoder-type-slot)`.
10. Assign `null` to `[codec implementation](#dom-imagedecoder-codec-implementation-slot)`.
11. If `init.preferAnimation` [exists](https://infra.spec.whatwg.org/#map-exists), assign `init.preferAnimation` to the `[prefer animation](#dom-imagedecoder-prefer-animation-slot)` internal slot. Otherwise, assign 'null' to `[prefer animation](#dom-imagedecoder-prefer-animation-slot)` internal slot.
12. Assign a new [list](https://infra.spec.whatwg.org/#list) to `[pending decode promises](#dom-imagedecoder-pending-decode-promises-slot)`.
13. Assign `-1` to `[internal selected track index](#dom-imagedecoder-internal-selected-track-index-slot)`.
14. Assign `false` to `[tracks established](#dom-imagedecoder-tracks-established-slot)`.
15. Assign `false` to `[closed](#dom-imagedecoder-closed-slot)`.
16. Assign a new [map](https://infra.spec.whatwg.org/#ordered-map) to `[progressive frame generations](#dom-imagedecoder-progressive-frame-generations-slot)`.
17. If init’s `[data](#dom-imagedecoderinit-data)` member is of type `[ReadableStream](https://streams.spec.whatwg.org/#readablestream)`:
1. Assign a new [list](https://infra.spec.whatwg.org/#list) to `[encoded data](#dom-imagedecoder-encoded-data-slot)`.
2. Assign `false` to `[complete](#dom-imagedecoder-complete-slot)`
3. [Queue a control message](#enqueues-a-control-message) to [configure the image decoder](#configure-the-image-decoder) with init.
4. [Process the control message queue](#process-the-control-message-queue).
5. Let reader be the result of [getting a reader](https://streams.spec.whatwg.org/#readablestream-get-a-reader) for `[data](#dom-imagedecoderinit-data)`.
6. In parallel, perform the [Fetch Stream Data Loop](#imagedecoder-fetch-stream-data-loop) on d with reader.
18. Otherwise:
1. Assert that `init.data` is of type `[BufferSource](https://webidl.spec.whatwg.org/#BufferSource)`.
2. If init.`[transfer](#dom-imagedecoderinit-transfer)` contains an `[ArrayBuffer](https://webidl.spec.whatwg.org/#idl-ArrayBuffer)` referenced by init.`[data](#dom-imagedecoderinit-data)` the User Agent _MAY_ choose to:
1. Let `[encoded data](#dom-imagedecoder-encoded-data-slot)` reference bytes in data representing an encoded image.
3. Otherwise:
1. Assign a copy of `init.data` to `[encoded data](#dom-imagedecoder-encoded-data-slot)`.
4. Assign `true` to `[complete](#dom-imagedecoder-complete-slot)`.
5. Resolve `[completed promise](#dom-imagedecoder-completed-promise-slot)`.
6. Queue a control message to [configure the image decoder](#configure-the-image-decoder) with init.
7. Queue a control message to [decode track metadata](#decode-track-metadata).
8. [Process the control message queue](#process-the-control-message-queue).
19. For each transferable in init.`[transfer](#dom-imagedecoderinit-transfer)`:
1. Perform [DetachArrayBuffer](https://tc39.es/ecma262/#sec-detacharraybuffer) on transferable
20. return d.
43. [Running a control message](#running-a-control-message) to configure the image decoder means running these steps:
1. Let supported be the result of running the [Check Type Support](#imagedecoder-check-type-support) algorithm with `init.type`.
2. If supported is `false`, run the [Close ImageDecoder](#imagedecoder-close-imagedecoder) algorithm with a `[NotSupportedError](https://webidl.spec.whatwg.org/#notsupportederror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)` and return "processed".
3. Otherwise, assign the `[codec implementation](#dom-imagedecoder-codec-implementation-slot)` internal slot with an implementation supporting `init.type`
4. Assign `true` to `[message queue blocked](#dom-imagedecoder-message-queue-blocked-slot)`.
5. Enqueue the following steps to the `[codec work queue](#dom-imagedecoder-codec-work-queue-slot)`:
1. Configure `[codec implementation](#dom-imagedecoder-codec-implementation-slot)` in accordance with the values given for `[colorSpaceConversion](#dom-imagedecoderinit-colorspaceconversion)`, `[desiredWidth](#dom-imagedecoderinit-desiredwidth)`, and `[desiredHeight](#dom-imagedecoderinit-desiredheight)`.
2. Assign `false` to `[message queue blocked](#dom-imagedecoder-message-queue-blocked-slot)`.
3. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to [Process the control message queue](#process-the-control-message-queue).
6. Return "processed".
53. [Running a control message](#running-a-control-message) to decode track metadata means running these steps:
1. Enqueue the following steps to the `[codec work queue](#dom-imagedecoder-codec-work-queue-slot)`:
1. Run the [Establish Tracks](#imagedecoder-establish-tracks) algorithm.


### decode

**Signature:** `Napi::Value decode(ImageDecodeOptions* options)`

**Algorithm:**

1. Enqueues a control message to decode the frame according to options.
2. When invoked, run these steps:
1. If `[closed](#dom-imagedecoder-closed-slot)` is `true`, return a `[Promise](https://webidl.spec.whatwg.org/#idl-promise)` rejected with an `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.
2. If `[ImageTrackList](#dom-imagedecoder-imagetracklist-slot)`’s `[selected index](#dom-imagetracklist-selected-index-slot)` is '-1', return a `[Promise](https://webidl.spec.whatwg.org/#idl-promise)` rejected with an `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.
3. If options is `undefined`, assign a new `[ImageDecodeOptions](#dictdef-imagedecodeoptions)` to options.
4. Let promise be a new `[Promise](https://webidl.spec.whatwg.org/#idl-promise)`.
5. Append promise to `[pending decode promises](#dom-imagedecoder-pending-decode-promises-slot)`.
6. [Queue a control message](#enqueues-a-control-message) to decode the image with options, and promise.
7. [Process the control message queue](#process-the-control-message-queue).
8. Return promise.
11. [Running a control message](#running-a-control-message) to decode the image means running these steps:
1. Enqueue the following steps to the `[codec work queue](#dom-imagedecoder-codec-work-queue-slot)`:
1. Wait for `[tracks established](#dom-imagedecoder-tracks-established-slot)` to become `true`.
2. If options.`[completeFramesOnly](#dom-imagedecodeoptions-completeframesonly)` is `false` and the image is a [Progressive Image](#progressive-image) for which the User Agent supports progressive decoding, run the [Decode Progressive Frame](#imagedecoder-decode-progressive-frame) algorithm with options.`[frameIndex](#dom-imagedecodeoptions-frameindex)` and promise.
3. Otherwise, run the [Decode Complete Frame](#imagedecoder-decode-complete-frame) algorithm with options.`[frameIndex](#dom-imagedecodeoptions-frameindex)` and promise.


### reset

**Signature:** `void reset()`

**Algorithm:**

1. Immediately aborts all pending work.
2. When invoked, run the [Reset ImageDecoder](#imagedecoder-reset-imagedecoder) algorithm with an `[AbortError](https://webidl.spec.whatwg.org/#aborterror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.


### close

**Signature:** `void close()`

**Algorithm:**

1. Immediately aborts all pending work and releases system resources. Close is final.
2. When invoked, run the [Close ImageDecoder](#imagedecoder-close-imagedecoder) algorithm with an `[AbortError](https://webidl.spec.whatwg.org/#aborterror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.


### isTypeSupported

**Static Method**

**Signature:** `Napi::Value isTypeSupported(std::string type)`

**Algorithm:**

1. Returns a promise indicating whether the provided config is supported by the User Agent.
2. When invoked, run these steps:
1. If type is not a [valid image MIME type](#valid-image-mime-type), return a `[Promise](https://webidl.spec.whatwg.org/#idl-promise)` rejected with `[TypeError](https://webidl.spec.whatwg.org/#exceptiondef-typeerror)`.
2. Let p be a new `[Promise](https://webidl.spec.whatwg.org/#idl-promise)`.
3. In parallel, resolve p with the result of running the [Check Type Support](#imagedecoder-check-type-support) algorithm with type.
4. Return p.

