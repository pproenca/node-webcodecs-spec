# AudioDecoder Specification

> **Source:** W3C WebCodecs (Auto-generated by scaffold-project.ts)

## Table of Contents

- [Description](#description)
- [Attributes](#attributes)
- [Methods](#methods)
  - [constructor](#constructor)
  - [configure](#configure)
  - [decode](#decode)
  - [flush](#flush)
  - [reset](#reset)
  - [close](#close)
  - [isConfigSupported](#isconfigsupported)


## Description

AudioDecoder interface from the W3C WebCodecs specification.

## Attributes

- **state** (`CodecState*`) [ReadOnly]
- **decodeQueueSize** (`uint32_t`) [ReadOnly]
- **ondequeue** (`EventHandler*`)

## Methods


### constructor

**Signature:** `constructor(AudioDecoderInit* init)`

**Algorithm:**

1. Initialize internal slots.


### configure

**Signature:** `void configure(AudioDecoderConfig* config)`

**Algorithm:**

1. [Enqueues a control message](#enqueues-a-control-message) to configure the audio decoder for decoding chunks as described by config.
2. NOTE: This method will trigger a `[NotSupportedError](https://webidl.spec.whatwg.org/#notsupportederror)` if the User Agent does not support config. Authors are encouraged to first check support by calling `[isConfigSupported()](#dom-audiodecoder-isconfigsupported)` with config. User Agents don’t have to support any particular codec type or configuration.
3. When invoked, run these steps:
1. If config is not a [valid AudioDecoderConfig](#valid-audiodecoderconfig), throw a `[TypeError](https://webidl.spec.whatwg.org/#exceptiondef-typeerror)`.
2. If `[state](#dom-audiodecoder-state-slot)` is `“closed”`, throw an `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)`.
3. Set `[state](#dom-audiodecoder-state-slot)` to "configured".
4. Set `[key chunk required](#dom-audiodecoder-key-chunk-required-slot)` to `true`.
5. [Queue a control message](#enqueues-a-control-message) to configure the decoder with config.
6. [Process the control message queue](#process-the-control-message-queue).
10. [Running a control message](#running-a-control-message) to configure the decoder means running these steps:
1. Assign `true` to `[message queue blocked](#dom-audiodecoder-message-queue-blocked-slot)`.
2. Enqueue the following steps to `[codec work queue](#dom-audiodecoder-codec-work-queue-slot)`:
1. Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
2. If supported is `false`, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close AudioDecoder](#close-audiodecoder) algorithm with `[NotSupportedError](https://webidl.spec.whatwg.org/#notsupportederror)` and abort these steps.
3. If needed, assign `[codec implementation](#dom-audiodecoder-codec-implementation-slot)` with an implementation supporting config.
4. Configure `[codec implementation](#dom-audiodecoder-codec-implementation-slot)` with config.
5. [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
1. Assign `false` to `[message queue blocked](#dom-audiodecoder-message-queue-blocked-slot)`.
2. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to [Process the control message queue](#process-the-control-message-queue).
3. Return "processed".


### decode

**Signature:** `void decode(EncodedAudioChunk* chunk)`

**Algorithm:**

1. [Enqueues a control message](#enqueues-a-control-message) to decode the given chunk.
2. When invoked, run these steps:
1. If `[state](#dom-audiodecoder-state-slot)` is not "configured", throw an `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)`.
2. If `[key chunk required](#dom-audiodecoder-key-chunk-required-slot)` is `true`:
1. If chunk.`[type](#dom-encodedaudiochunk-type-slot)` is not `[key](#dom-encodedaudiochunktype-key)`, throw a `[DataError](https://webidl.spec.whatwg.org/#dataerror)`.
2. Implementers _SHOULD_ inspect the chunk’s `[internal data](#dom-encodedaudiochunk-internal-data-slot)` to verify that it is truly a [key chunk](#key-chunk). If a mismatch is detected, throw a `[DataError](https://webidl.spec.whatwg.org/#dataerror)`.
3. Otherwise, assign `false` to `[key chunk required](#dom-audiodecoder-key-chunk-required-slot)`.
3. Increment `[decodeQueueSize](#dom-audiodecoder-decodequeuesize-slot)`.
4. [Queue a control message](#enqueues-a-control-message) to decode the chunk.
5. [Process the control message queue](#process-the-control-message-queue).
11. [Running a control message](#running-a-control-message) to decode the chunk means performing these steps:
1. If `[codec saturated](#dom-audiodecoder-codec-saturated-slot)` equals `true`, return "not processed".
2. If decoding chunk will cause the `[codec implementation](#dom-audiodecoder-codec-implementation-slot)` to become [saturated](#saturated), assign `true` to `[codec saturated](#dom-audiodecoder-codec-saturated-slot)`.
3. Decrement `[decodeQueueSize](#dom-audiodecoder-decodequeuesize-slot)` and run the [Schedule Dequeue Event](#audiodecoder-schedule-dequeue-event) algorithm.
4. Enqueue the following steps to the `[codec work queue](#dom-audiodecoder-codec-work-queue-slot)`:
1. Attempt to use `[codec implementation](#dom-audiodecoder-codec-implementation-slot)` to decode the chunk.
2. If decoding results in an error, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Close AudioDecoder](#close-audiodecoder) algorithm with `[EncodingError](https://webidl.spec.whatwg.org/#encodingerror)` and return.
3. If `[codec saturated](#dom-audiodecoder-codec-saturated-slot)` equals `true` and `[codec implementation](#dom-audiodecoder-codec-implementation-slot)` is no longer [saturated](#saturated), [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform the following steps:
1. Assign `false` to `[codec saturated](#dom-audiodecoder-codec-saturated-slot)`.
2. [Process the control message queue](#process-the-control-message-queue).
4. Let decoded outputs be a [list](https://infra.spec.whatwg.org/#list) of decoded audio data outputs emitted by `[codec implementation](#dom-audiodecoder-codec-implementation-slot)`.
5. If decoded outputs is not empty, [queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the [Output AudioData](#output-audiodata) algorithm with decoded outputs.
5. Return "processed".


### flush

**Signature:** `Napi::Value flush()`

**Algorithm:**

1. Completes all [control messages](#control-message) in the [control message queue](#control-message-queue) and emits all outputs.
2. When invoked, run these steps:
1. If `[state](#dom-audiodecoder-state-slot)` is not "configured", return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) `[InvalidStateError](https://webidl.spec.whatwg.org/#invalidstateerror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.
2. Set `[key chunk required](#dom-audiodecoder-key-chunk-required-slot)` to `true`.
3. Let promise be a new Promise.
4. Append promise to `[pending flush promises](#dom-audiodecoder-pending-flush-promises-slot)`.
5. [Queue a control message](#enqueues-a-control-message) to flush the codec with promise.
6. [Process the control message queue](#process-the-control-message-queue).
7. Return promise.
10. [Running a control message](#running-a-control-message) to flush the codec means performing these steps with promise.
1. Enqueue the following steps to the `[codec work queue](#dom-audiodecoder-codec-work-queue-slot)`:
1. Signal `[codec implementation](#dom-audiodecoder-codec-implementation-slot)` to emit all [internal pending outputs](#internal-pending-output).
2. Let decoded outputs be a [list](https://infra.spec.whatwg.org/#list) of decoded audio data outputs emitted by `[codec implementation](#dom-audiodecoder-codec-implementation-slot)`.
3. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to perform these steps:
1. If decoded outputs is not empty, run the [Output AudioData](#output-audiodata) algorithm with decoded outputs.
2. Remove promise from `[pending flush promises](#dom-audiodecoder-pending-flush-promises-slot)`.
3. Resolve promise.
2. Return "processed".


### reset

**Signature:** `void reset()`

**Algorithm:**

1. Immediately resets all state including configuration, [control messages](#control-message) in the [control message queue](#control-message-queue), and all pending callbacks.
2. When invoked, run the [Reset AudioDecoder](#reset-audiodecoder) algorithm with an `[AbortError](https://webidl.spec.whatwg.org/#aborterror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.


### close

**Signature:** `void close()`

**Algorithm:**

1. Immediately aborts all pending work and releases [system resources](#system-resources). Close is final.
2. When invoked, run the [Close AudioDecoder](#close-audiodecoder) algorithm with an `[AbortError](https://webidl.spec.whatwg.org/#aborterror)` `[DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)`.


### isConfigSupported

**Static Method**

**Signature:** `Napi::Value isConfigSupported(AudioDecoderConfig* config)`

**Algorithm:**

1. Returns a promise indicating whether the provided config is supported by the User Agent.
2. NOTE: The returned `[AudioDecoderSupport](#dictdef-audiodecodersupport)` `[config](#dom-audiodecodersupport-config)` will contain only the dictionary members that User Agent recognized. Unrecognized dictionary members will be ignored. Authors can detect unrecognized dictionary members by comparing `[config](#dom-audiodecodersupport-config)` to their provided config.
3. When invoked, run these steps:
1. If config is not a [valid AudioDecoderConfig](#valid-audiodecoderconfig), return [a promise rejected with](https://webidl.spec.whatwg.org/#a-promise-rejected-with) `[TypeError](https://webidl.spec.whatwg.org/#exceptiondef-typeerror)`.
2. Let p be a new Promise.
3. Let checkSupportQueue be the result of starting a new [parallel queue](https://html.spec.whatwg.org/multipage/infrastructure.html#parallel-queue).
4. Enqueue the following steps to checkSupportQueue:
1. Let supported be the result of running the [Check Configuration Support](#check-configuration-support) algorithm with config.
2. [Queue a task](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task) to run the following steps:
1. Let decoderSupport be a newly constructed `[AudioDecoderSupport](#dictdef-audiodecodersupport)`, initialized as follows:
1. Set `[config](#dom-audiodecodersupport-config)` to the result of running the [Clone Configuration](#clone-configuration) algorithm with config.
2. Set `[supported](#dom-audiodecodersupport-supported)` to supported.
2. Resolve p with decoderSupport.
5. Return p.

